const E=(e,t)=>t.some(n=>e instanceof n);let g,m;function h(){return g||(g=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function w(){return m||(m=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const B=new WeakMap,f=new WeakMap,b=new WeakMap,p=new WeakMap,l=new WeakMap;function L(e){const t=new Promise((n,o)=>{const i=()=>{e.removeEventListener("success",a),e.removeEventListener("error",r)},a=()=>{n(c(e.result)),i()},r=()=>{o(e.error),i()};e.addEventListener("success",a),e.addEventListener("error",r)});return t.then(n=>{n instanceof IDBCursor&&B.set(n,e)}).catch(()=>{}),l.set(t,e),t}function j(e){if(f.has(e))return;const t=new Promise((n,o)=>{const i=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",r),e.removeEventListener("abort",r)},a=()=>{n(),i()},r=()=>{o(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",a),e.addEventListener("error",r),e.addEventListener("abort",r)});f.set(e,t)}let D={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return f.get(e);if(t==="objectStoreNames")return e.objectStoreNames||b.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return c(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function S(e){D=e(D)}function k(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...n){const o=e.call(v(this),t,...n);return b.set(o,t.sort?t.sort():[t]),c(o)}:w().includes(e)?function(...t){return e.apply(v(this),t),c(B.get(this))}:function(...t){return c(e.apply(v(this),t))}}function x(e){return typeof e=="function"?k(e):(e instanceof IDBTransaction&&j(e),E(e,h())?new Proxy(e,D):e)}function c(e){if(e instanceof IDBRequest)return L(e);if(p.has(e))return p.get(e);const t=x(e);return t!==e&&(p.set(e,t),l.set(t,e)),t}const v=e=>l.get(e);function M(e,t,{blocked:n,upgrade:o,blocking:i,terminated:a}={}){const r=indexedDB.open(e,t),d=c(r);return o&&r.addEventListener("upgradeneeded",s=>{o(c(r.result),s.oldVersion,s.newVersion,c(r.transaction),s)}),n&&r.addEventListener("blocked",s=>n(s.oldVersion,s.newVersion,s)),d.then(s=>{a&&s.addEventListener("close",()=>a()),i&&s.addEventListener("versionchange",u=>i(u.oldVersion,u.newVersion,u))}).catch(()=>{}),d}const V=["get","getKey","getAll","getAllKeys","count"],C=["put","add","delete","clear"],I=new Map;function y(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(I.get(t))return I.get(t);const n=t.replace(/FromIndex$/,""),o=t!==n,i=C.includes(n);if(!(n in(o?IDBIndex:IDBObjectStore).prototype)||!(i||V.includes(n)))return;const a=async function(r,...d){const s=this.transaction(r,i?"readwrite":"readonly");let u=s.store;return o&&(u=u.index(d.shift())),(await Promise.all([u[n](...d),i&&s.done]))[0]};return I.set(t,a),a}S(e=>({...e,get:(t,n,o)=>y(t,n)||e.get(t,n,o),has:(t,n)=>!!y(t,n)||e.has(t,n)}));export{M as o};
